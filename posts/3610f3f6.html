<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="baidu-site-verification" content="vgpRFHlTIC"><meta name="google-site-verification" content="BnECCcP14gKaNCZHg-CJxMD4dRHmp6DlDMAfoXftVjU"><meta name="msvalidate.01" content="FD9F235D89800A839E28F52E0F487AFA"><script src="https://cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.3.0",sidebar:{position:"left",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!0,fastclick:!0,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="9 PHP中的资源类型截止到现在，我们已经熟悉了PHP语言中的字符串、数字、布尔以及数组的数据类型了，接下来，我们将接触另外一种PHP独特的数据类型——资源（Resource）。9.1 PHP中的资源类型讲述之前，先描述下{资源}类型在内核中的结构：1234567//每一个资源都是通过它来实现的。typedef struct _zend_rsrc_list_entry&amp;#123;	void *pt"><meta name="keywords" content="php_ext"><meta property="og:type" content="article"><meta property="og:title" content="9 PHP中的资源类型"><meta property="og:url" content="https://phantom9999.github.io/posts/3610f3f6.html"><meta property="og:site_name" content="phantom9999的博客"><meta property="og:description" content="9 PHP中的资源类型截止到现在，我们已经熟悉了PHP语言中的字符串、数字、布尔以及数组的数据类型了，接下来，我们将接触另外一种PHP独特的数据类型——资源（Resource）。9.1 PHP中的资源类型讲述之前，先描述下{资源}类型在内核中的结构：1234567//每一个资源都是通过它来实现的。typedef struct _zend_rsrc_list_entry&amp;#123;	void *pt"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2018-02-01T20:07:09.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="9 PHP中的资源类型"><meta name="twitter:description" content="9 PHP中的资源类型截止到现在，我们已经熟悉了PHP语言中的字符串、数字、布尔以及数组的数据类型了，接下来，我们将接触另外一种PHP独特的数据类型——资源（Resource）。9.1 PHP中的资源类型讲述之前，先描述下{资源}类型在内核中的结构：1234567//每一个资源都是通过它来实现的。typedef struct _zend_rsrc_list_entry&amp;#123;	void *pt"><link rel="canonical" href="https://phantom9999.github.io/posts/3610f3f6.html"><script type="text/javascript" id="page.configurations">CONFIG.page={sidebar:""}</script><title>9 PHP中的资源类型 | phantom9999的博客</title><style>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,hgroup,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:700}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sup{top:-.5em}sub{bottom:-.25em}img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}button,input,optgroup,select,textarea{color:inherit;font:inherit;margin:0}button{overflow:visible}button,select{text-transform:none}button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}input{line-height:normal}input[type=checkbox],input[type=radio]{box-sizing:border-box;padding:0}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{height:auto}input[type=search]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}input[type=search]::-webkit-search-cancel-button,input[type=search]::-webkit-search-decoration{-webkit-appearance:none}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{border:0;padding:0}textarea{overflow:auto}optgroup{font-weight:700}table{border-collapse:collapse;border-spacing:0}td,th{padding:0}::selection{background:#262a30;color:#fff}body{position:relative;font-family:Lato,"PingFang SC","Microsoft YaHei",sans-serif;font-size:14px;line-height:2;color:#555;background:#eee}@media (max-width:767px){body{padding-right:0!important}}@media (min-width:768px) and (max-width:991px){body{padding-right:0!important}}@media (min-width:1600px){body{font-size:16px}}h1,h2,h3,h4,h5,h6{margin:0;padding:0;font-weight:700;line-height:1.5;font-family:Lato,"PingFang SC","Microsoft YaHei",sans-serif}h1,h2,h3,h4,h5,h6{margin:20px 0 15px}h1{font-size:22px}@media (max-width:767px){h1{font-size:18px}}h2{font-size:20px}@media (max-width:767px){h2{font-size:16px}}h3{font-size:18px}@media (max-width:767px){h3{font-size:14px}}h4{font-size:16px}@media (max-width:767px){h4{font-size:12px}}h5{font-size:14px}@media (max-width:767px){h5{font-size:10px}}h6{font-size:12px}@media (max-width:767px){h6{font-size:8px}}p{margin:0 0 20px 0}a{color:#555;text-decoration:none;outline:0;border-bottom:1px solid #999;word-wrap:break-word}a:hover{color:#222;border-bottom-color:#222}blockquote{margin:0;padding:0}img{display:block;margin:auto;max-width:100%;height:auto}hr{margin:40px 0;height:3px;border:none;background-color:#ddd;background-image:repeating-linear-gradient(-45deg,#fff,#fff 4px,transparent 4px,transparent 8px)}blockquote{padding:0 15px;color:#666;border-left:4px solid #ddd}blockquote cite::before{content:"-";padding:0 5px}dt{font-weight:700}dd{margin:0;padding:0}kbd{border:1px solid #ccc;border-radius:.2em;box-shadow:.1em .1em .2em rgba(0,0,0,.1);background-color:#f9f9f9;font-family:inherit;background-image:-webkit-linear-gradient(top,#eee,#fff,#eee);padding:.1em .3em;white-space:nowrap}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-justify{text-align:justify}.text-nowrap{white-space:nowrap}.text-lowercase{text-transform:lowercase}.text-uppercase{text-transform:uppercase}.text-capitalize{text-transform:capitalize}.center-block{display:block;margin-left:auto;margin-right:auto}.clearfix:after,.clearfix:before{content:" ";display:table}.clearfix:after{clear:both}.pullquote{width:45%}.pullquote.left{float:left;margin-left:5px;margin-right:10px}.pullquote.right{float:right;margin-left:10px;margin-right:5px}.affix.affix.affix{position:fixed}.translation{margin-top:-20px;font-size:14px;color:#999}.scrollbar-measure{width:100px;height:100px;overflow:scroll;position:absolute;top:-9999px}.use-motion .motion-element{opacity:0}table{margin:20px 0;width:100%;border-collapse:collapse;border-spacing:0;border:1px solid #ddd;font-size:14px;word-wrap:break-all}table>tbody>tr:nth-of-type(odd){background-color:#f9f9f9}table>tbody>tr:hover{background-color:#f5f5f5}caption,td,th{padding:8px;text-align:left;vertical-align:middle;font-weight:400}td,th{border-bottom:3px solid #ddd;border-right:1px solid #eee}th{padding-bottom:10px;font-weight:700}td{border-bottom-width:1px}body,html{height:100%}.container{position:relative;min-height:100%}.header-inner{margin:0 auto;padding:100px 0 70px;width:calc(100% - 252px)}@media (min-width:1600px){.container .header-inner{width:900px}}.main{padding-bottom:150px}.main-inner{margin:0 auto;width:calc(100% - 252px)}@media (min-width:1600px){.container .main-inner{width:900px}}.footer{position:absolute;left:0;bottom:0;width:100%;min-height:50px}.footer-inner{box-sizing:border-box;margin:20px auto;width:calc(100% - 252px)}@media (min-width:1600px){.container .footer-inner{width:900px}}.highlight,pre{overflow:auto;margin:20px 0;padding:0;font-size:14px;color:#ccc;background:#2d2d2d;line-height:1.6}code,pre{font-family:consolas,Menlo,"PingFang SC","Microsoft YaHei",monospace}code{padding:2px 4px;word-wrap:break-word;color:#555;background:#eee;border-radius:3px;font-size:14px}pre{padding:10px}pre code{padding:0;color:#ccc;background:0 0;text-shadow:none}.highlight{border-radius:1px}.highlight pre{border:none;margin:0;padding:10px 0}.highlight table{margin:0;width:auto;border:none}.highlight td{border:none;padding:0}.highlight figcaption{font-size:1em;color:#ccc;line-height:1em;margin-bottom:1em;margin:0;padding:.5em;background:#eee;border-bottom:1px solid #e9e9e9}.highlight figcaption:after,.highlight figcaption:before{content:" ";display:table}.highlight figcaption:after{clear:both}.highlight figcaption a{float:right;color:#ccc}.highlight figcaption a:hover{border-bottom-color:#ccc}.highlight .gutter pre{padding-left:10px;padding-right:10px;color:#999;text-align:right;background-color:#1b1b1b}.highlight .code pre{width:100%;padding-left:10px;padding-right:10px;background-color:#2d2d2d}.highlight .line{height:20px}.gutter{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.gist table{width:auto}.gist table td{border:none}pre .deletion{background:green}pre .addition{background:maroon}pre .meta{color:#c9c}pre .comment{color:#999}pre .attribute,pre .css .class,pre .css .id,pre .css .pseudo,pre .html .doctype,pre .regexp,pre .ruby .constant,pre .tag,pre .variable,pre .xml .doctype,pre .xml .pi,pre .xml .tag .title{color:#f2777a}pre .built_in,pre .command,pre .constant,pre .literal,pre .number,pre .params,pre .preprocessor{color:#f99157}pre .css .rules .attribute,pre .formula,pre .header,pre .inheritance,pre .number,pre .ruby .class .title,pre .ruby .symbol,pre .special,pre .string,pre .value,pre .xml .cdata{color:#9c9}pre .css .hexcolor,pre .title{color:#6cc}pre .coffeescript .title,pre .function,pre .javascript .title,pre .perl .sub,pre .python .decorator,pre .python .title,pre .ruby .function .title,pre .ruby .title .keyword{color:#69c}pre .javascript .function,pre .keyword{color:#c9c}.full-image.full-image.full-image.full-image{border:none;max-width:100%;width:auto;margin:20px auto 25px}.blockquote-center,.page-home .post-type-quote blockquote,.page-post-detail .post-type-quote blockquote{position:relative;margin:40px 0;padding:0;border-left:none;text-align:center}.blockquote-center::after,.blockquote-center::before,.page-home .post-type-quote blockquote::after,.page-home .post-type-quote blockquote::before,.page-post-detail .post-type-quote blockquote::after,.page-post-detail .post-type-quote blockquote::before{position:absolute;content:' ';display:block;width:100%;height:24px;opacity:.2;background-repeat:no-repeat;background-position:0 -6px;background-size:22px 22px}.blockquote-center::before,.page-home .post-type-quote blockquote::before,.page-post-detail .post-type-quote blockquote::before{top:-20px;background-image:url(../images/quote-l.svg);border-top:1px solid #ccc}.blockquote-center::after,.page-home .post-type-quote blockquote::after,.page-post-detail .post-type-quote blockquote::after{bottom:-20px;background-image:url(../images/quote-r.svg);border-bottom:1px solid #ccc;background-position:100% 8px}.blockquote-center div,.blockquote-center p,.page-home .post-type-quote blockquote div,.page-home .post-type-quote blockquote p,.page-post-detail .post-type-quote blockquote div,.page-post-detail .post-type-quote blockquote p{text-align:center}.post .post-body .group-picture img{box-sizing:border-box;padding:0 3px;border:none}.post .group-picture-row{overflow:hidden;margin-top:6px}.post .group-picture-row:first-child{margin-top:0}.post .group-picture-column{float:left}.page-post-detail .post-body .group-picture-column{float:none;margin-top:10px;width:auto!important}.page-post-detail .post-body .group-picture-column img{margin:0 auto}.page-archive .group-picture-container{overflow:hidden}.page-archive .group-picture-row{float:left}.page-archive .group-picture-row:first-child{margin-top:6px}.page-archive .group-picture-column{max-width:150px;max-height:150px}.post-body .note{position:relative;padding:15px;margin-bottom:20px;border:1px solid transparent;background-color:#f5f5f5;border-radius:3px}.post-body .note h2,.post-body .note h3,.post-body .note h4,.post-body .note h5,.post-body .note h6{margin-top:0;margin-bottom:0;border-bottom:initial;padding-top:0!important}.post-body .note blockquote:first-child,.post-body .note ol:first-child,.post-body .note p:first-child,.post-body .note pre:first-child,.post-body .note table:first-child,.post-body .note ul:first-child{margin-top:0}.post-body .note blockquote:last-child,.post-body .note ol:last-child,.post-body .note p:last-child,.post-body .note pre:last-child,.post-body .note table:last-child,.post-body .note ul:last-child{margin-bottom:0}.post-body .note.default{background-color:#f3f3f3;border-color:#e1e1e1;color:#666}.post-body .note.default a:not(.btn){color:#666;border-bottom:1px solid #666}.post-body .note.default a:not(.btn):hover{color:#454545;border-bottom:1px solid #454545}.post-body .note.primary{background-color:#f3daff;border-color:#e1c2ff;color:#6f42c1}.post-body .note.primary a:not(.btn){color:#6f42c1;border-bottom:1px solid #6f42c1}.post-body .note.primary a:not(.btn):hover{color:#453298;border-bottom:1px solid #453298}.post-body .note.info{background-color:#d9edf7;border-color:#b3e5ef;color:#31708f}.post-body .note.info a:not(.btn){color:#31708f;border-bottom:1px solid #31708f}.post-body .note.info a:not(.btn):hover{color:#215761;border-bottom:1px solid #215761}.post-body .note.success{background-color:#dff0d8;border-color:#d0e6be;color:#3c763d}.post-body .note.success a:not(.btn){color:#3c763d;border-bottom:1px solid #3c763d}.post-body .note.success a:not(.btn):hover{color:#32562c;border-bottom:1px solid #32562c}.post-body .note.warning{background-color:#fcf4e3;border-color:#fae4cd;color:#8a6d3b}.post-body .note.warning a:not(.btn){color:#8a6d3b;border-bottom:1px solid #8a6d3b}.post-body .note.warning a:not(.btn):hover{color:#714f30;border-bottom:1px solid #714f30}.post-body .note.danger{background-color:#f2dfdf;border-color:#ebcdd2;color:#a94442}.post-body .note.danger a:not(.btn){color:#a94442;border-bottom:1px solid #a94442}.post-body .note.danger a:not(.btn):hover{color:#84333f;border-bottom:1px solid #84333f}.post-body .label{display:inline;padding:0 2px;white-space:nowrap}.post-body .label.default{background-color:#f0f0f0}.post-body .label.primary{background-color:#efe6f7}.post-body .label.info{background-color:#e5f2f8}.post-body .label.success{background-color:#e7f4e9}.post-body .label.warning{background-color:#fcf6e1}.post-body .label.danger{background-color:#fae8eb}.post-body .tabs{position:relative;display:block;margin-bottom:20px;padding-top:10px}.post-body .tabs ul.nav-tabs{margin:0;padding:0;display:flex;margin-bottom:-1px}@media (max-width:413px){.post-body .tabs ul.nav-tabs{display:block;margin-bottom:5px}}.post-body .tabs ul.nav-tabs li.tab{list-style-type:none!important;margin:0 .25em 0 0;border-top:3px solid transparent;border-left:1px solid transparent;border-right:1px solid transparent}@media (max-width:413px){.post-body .tabs ul.nav-tabs li.tab{margin:initial;border-top:1px solid transparent;border-left:3px solid transparent;border-right:1px solid transparent;border-bottom:1px solid transparent}}.post-body .tabs ul.nav-tabs li.tab a{outline:0;border-bottom:initial;display:block;line-height:1.8em;padding:.25em .75em;transition-duration:.2s;transition-timing-function:ease-out;transition-delay:0s}.post-body .tabs ul.nav-tabs li.tab a i{width:1.285714285714286em}.post-body .tabs ul.nav-tabs li.tab.active{border-top:3px solid #fc6423;border-left:1px solid #ddd;border-right:1px solid #ddd;background-color:#fff}@media (max-width:413px){.post-body .tabs ul.nav-tabs li.tab.active{border-top:1px solid #ddd;border-left:3px solid #fc6423;border-right:1px solid #ddd;border-bottom:1px solid #ddd}}.post-body .tabs ul.nav-tabs li.tab.active a{cursor:default;color:#555}.post-body .tabs .tab-content{background-color:#fff}.post-body .tabs .tab-content .tab-pane{border:1px solid #ddd;padding:20px 20px 0 20px}.post-body .tabs .tab-content .tab-pane:not(.active){display:none!important}.post-body .tabs .tab-content .tab-pane.active{display:block!important}.btn{display:inline-block;padding:0 20px;font-size:14px;color:#555;background:#fff;border:2px solid #555;text-decoration:none;border-radius:2px;transition-property:background-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;line-height:2}.btn:hover{border-color:#222;color:#fff;background:#222}.btn+.btn{margin:0 0 8px 8px}.btn .fa-fw{width:1.285714285714286em;text-align:left}.btn-bar{display:block;width:22px;height:2px;background:#555;border-radius:1px}.btn-bar+.btn-bar{margin-top:4px}.pagination{margin:120px 0 40px;text-align:center;border-top:1px solid #eee}.page-number-basic,.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{display:inline-block;position:relative;top:-1px;margin:0 10px;padding:0 11px}@media (max-width:767px){.page-number-basic,.pagination .next,.pagination .page-number,.pagination .prev,.pagination .space{margin:0 5px}}.pagination .next,.pagination .page-number,.pagination .prev{border-bottom:0;border-top:1px solid #eee;transition-property:border-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-top-color:#222}.pagination .space{padding:0;margin:0}.pagination .prev{margin-left:0}.pagination .next{margin-right:0}.pagination .page-number.current{color:#fff;background:#ccc;border-top-color:#ccc}@media (max-width:767px){.pagination{border-top:none}.pagination .next,.pagination .page-number,.pagination .prev{margin-bottom:10px;border-top:0;border-bottom:1px solid #eee;padding:0 10px}.pagination .next:hover,.pagination .page-number:hover,.pagination .prev:hover{border-bottom-color:#222}}.comments{margin:60px 20px 0}.tag-cloud{text-align:center}.tag-cloud a{display:inline-block;margin:10px}.back-to-top{display:none;margin:20px -10px -20px;background:#eee;font-size:12px;opacity:.6;cursor:pointer;text-align:center;-webkit-transform:translateZ(0);transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.back-to-top:hover{opacity:.8}@media (min-width:768px) and (max-width:991px){.back-to-top{display:none!important}}@media (max-width:767px){.back-to-top{display:none!important}}.back-to-top.back-to-top-on{display:block}.header{background:0 0}.header-inner{position:relative}.headband{height:3px;background:#222}.site-meta{margin:0;text-align:center}@media (max-width:767px){.site-meta{text-align:center}}.brand{position:relative;display:inline-block;padding:0 40px;color:#fff;background:#222;border-bottom:none}.brand:hover{color:#fff}.logo{display:inline-block;margin-right:5px;line-height:36px;vertical-align:top}.site-title{display:inline-block;vertical-align:top;line-height:36px;font-size:20px;font-weight:400;font-family:Lato,"PingFang SC","Microsoft YaHei",sans-serif}.site-subtitle{margin-top:10px;font-size:13px;color:#ddd}.use-motion .brand{opacity:0}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:0;position:relative;top:-10px}.site-nav-toggle{display:none;position:absolute;top:10px;left:10px}@media (max-width:767px){.site-nav-toggle{display:block}}.site-nav-toggle button{margin-top:2px;padding:9px 10px;background:0 0;border:none}@media (max-width:767px){.site-nav{display:none;margin:0 -10px;padding:0 10px;clear:both;border-top:1px solid #ddd}}@media (min-width:768px) and (max-width:991px){.site-nav{display:block!important}}@media (min-width:992px){.site-nav{display:block!important}}.menu{margin-top:20px;padding-left:0;text-align:center}.menu .menu-item{display:inline-block;margin:0 10px;list-style:none}@media screen and (max-width:767px){.menu .menu-item{margin-top:10px}}.menu .menu-item a{display:block;font-size:13px;line-height:inherit;border-bottom:1px solid transparent;transition-property:border-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.menu .menu-item a:hover,.menu-item-active a{border-bottom-color:#222}.menu .menu-item .fa{margin-right:5px}.use-motion .menu-item{opacity:0}.post-body{font-family:Lato,"PingFang SC","Microsoft YaHei",sans-serif}@media (max-width:767px){.post-body{word-break:break-word}}.post-body .fancybox img{display:block!important;margin:0 auto;cursor:pointer;cursor:zoom-in;cursor:-webkit-zoom-in}.post-body .figure .caption,.post-body .image-caption{margin:-20px auto 15px;text-align:center;font-size:14px;color:#999;font-weight:700;line-height:1}.post-sticky-flag{display:inline-block;font-size:16px;-ms-transform:rotate(30deg);-webkit-transform:rotate(30deg);-moz-transform:rotate(30deg);-ms-transform:rotate(30deg);-o-transform:rotate(30deg);transform:rotate(30deg)}.use-motion .comments,.use-motion .pagination,.use-motion .post-block{opacity:0}.use-motion .post-header{opacity:0}.use-motion .post-body{opacity:0}.use-motion .collection-title{opacity:0}.posts-expand{padding-top:40px}@media (max-width:767px){.posts-expand{margin:0 20px}.post-body pre .gutter pre{padding-right:10px}.post-body .highlight{margin-left:0;margin-right:0;padding:0}.post-body .highlight .gutter pre{padding-right:10px}}@media (min-width:992px){.posts-expand .post-body{text-align:justify}}.posts-expand .post-body h2,.posts-expand .post-body h3,.posts-expand .post-body h4,.posts-expand .post-body h5,.posts-expand .post-body h6{padding-top:10px}.posts-expand .post-body h2 .header-anchor,.posts-expand .post-body h3 .header-anchor,.posts-expand .post-body h4 .header-anchor,.posts-expand .post-body h5 .header-anchor,.posts-expand .post-body h6 .header-anchor{float:right;margin-left:10px;color:#ccc;border-bottom-style:none;visibility:hidden}.posts-expand .post-body h2 .header-anchor:hover,.posts-expand .post-body h3 .header-anchor:hover,.posts-expand .post-body h4 .header-anchor:hover,.posts-expand .post-body h5 .header-anchor:hover,.posts-expand .post-body h6 .header-anchor:hover{color:inherit}.posts-expand .post-body h2:hover .header-anchor,.posts-expand .post-body h3:hover .header-anchor,.posts-expand .post-body h4:hover .header-anchor,.posts-expand .post-body h5:hover .header-anchor,.posts-expand .post-body h6:hover .header-anchor{visibility:visible}.posts-expand .post-body ul li{list-style:circle}.posts-expand .post-body img{box-sizing:border-box;margin:auto;padding:3px;border:1px solid #ddd}.posts-expand .post-body .fancybox img{margin:0 auto 25px}.posts-expand .post-body img{margin:0 auto 25px}@media (max-width:767px){.posts-collapse{margin:0 20px}.posts-collapse .post-meta,.posts-collapse .post-title{display:block;width:auto;text-align:left}}.posts-collapse{position:relative;z-index:1010;margin-left:55px}.posts-collapse::after{content:" ";position:absolute;top:20px;left:0;margin-left:-2px;width:4px;height:100%;background:#f5f5f5;z-index:-1}@media (max-width:767px){.posts-collapse{margin:0 20px}}.posts-collapse .collection-title{position:relative;margin:60px 0}.posts-collapse .collection-title h1,.posts-collapse .collection-title h2{margin-left:20px}.posts-collapse .collection-title small{color:#bbb;margin-left:5px}.posts-collapse .collection-title::before{content:" ";position:absolute;left:0;top:50%;margin-left:-4px;margin-top:-4px;width:8px;height:8px;background:#bbb;border-radius:50%}.posts-collapse .post{margin:30px 0}.posts-collapse .post-header{position:relative;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;transition-property:border;border-bottom:1px dashed #ccc}.posts-collapse .post-header::before{content:" ";position:absolute;left:0;top:12px;width:6px;height:6px;margin-left:-4px;background:#bbb;border-radius:50%;border:1px solid #fff;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;transition-property:background}.posts-collapse .post-header:hover{border-bottom-color:#666}.posts-collapse .post-header:hover::before{background:#222}.posts-collapse .post-meta{position:absolute;font-size:12px;left:20px;top:5px}.posts-collapse .post-comments-count{display:none}.posts-collapse .post-title{margin-left:60px;font-size:16px;font-weight:400;line-height:inherit}.posts-collapse .post-title::after{margin-left:3px;opacity:.6}.posts-collapse .post-title a{color:#666;border-bottom:none}.page-home .post-type-quote .post-header,.page-home .post-type-quote .post-tags,.page-post-detail .post-type-quote .post-header,.page-post-detail .post-type-quote .post-tags{display:none}.posts-expand .post-title{text-align:center;word-break:break-word;font-weight:400}.posts-expand .post-title-link{display:inline-block;position:relative;color:#555;border-bottom:none;line-height:1.2;vertical-align:top}.posts-expand .post-title-link::before{content:"";position:absolute;width:100%;height:2px;bottom:0;left:0;background-color:#000;visibility:hidden;-webkit-transform:scaleX(0);-moz-transform:scaleX(0);-ms-transform:scaleX(0);-o-transform:scaleX(0);transform:scaleX(0);transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.posts-expand .post-title-link:hover::before{visibility:visible;-webkit-transform:scaleX(1);-moz-transform:scaleX(1);-ms-transform:scaleX(1);-o-transform:scaleX(1);transform:scaleX(1)}.posts-expand .post-title-link .fa{font-size:16px}.posts-expand .post-meta{margin:3px 0 60px 0;color:#999;font-family:Lato,"PingFang SC","Microsoft YaHei",sans-serif;font-size:12px;text-align:center}.posts-expand .post-meta .post-category-list{display:inline-block;margin:0;padding:3px}.posts-expand .post-meta .post-category-list-link{color:#999}.posts-expand .post-meta .post-description{font-size:14px;margin-top:2px}.posts-expand .post-meta time{border-bottom:1px dashed #999;cursor:help}.post-meta-divider{margin:0 .5em}.post-meta-item-icon{margin-right:3px}@media (min-width:768px) and (max-width:991px){.post-meta-item-icon{display:inline-block}}@media (max-width:767px){.post-meta-item-icon{display:inline-block}}@media (min-width:768px) and (max-width:991px){.post-meta-item-text{display:none}}@media (max-width:767px){.post-meta-item-text{display:none}}.post-button{margin-top:40px}.posts-expand .post-tags{margin-top:40px;text-align:center}.posts-expand .post-tags a{display:inline-block;margin-right:10px;font-size:13px}.post-nav{display:table;margin-top:15px;width:100%;border-top:1px solid #eee}.post-nav-divider{display:table-cell;width:10%}.post-nav-item{display:table-cell;padding:10px 0 0 0;width:45%;vertical-align:top}.post-nav-item a{position:relative;display:block;line-height:25px;font-size:14px;color:#555;border-bottom:none}.post-nav-item a:hover{color:#222;border-bottom:none}.post-nav-item a:active{top:2px}.post-nav-item .fa{position:absolute;top:8px;left:0;font-size:12px}.post-nav-next a{padding-left:15px}.post-nav-prev{text-align:right}.post-nav-prev a{padding-right:15px}.post-nav-prev .fa{right:0;left:auto}.posts-expand .post-eof{display:block;margin:80px auto 60px;width:8%;height:1px;background:#ccc;text-align:center}.post:last-child .post-eof.post-eof.post-eof{display:none}.post-gallery{display:table;table-layout:fixed;width:100%;border-collapse:separate}.post-gallery-row{display:table-row}.post-gallery .post-gallery-img{display:table-cell;text-align:center;vertical-align:middle;border:none}.post-gallery .post-gallery-img img{max-width:100%;max-height:100%;border:none}.fancybox-close,.fancybox-close:hover{border:none}.rtl.post-body a,.rtl.post-body h1,.rtl.post-body h2,.rtl.post-body h3,.rtl.post-body h4,.rtl.post-body h5,.rtl.post-body h6,.rtl.post-body li,.rtl.post-body ol,.rtl.post-body p,.rtl.post-body ul{direction:rtl;font-family:UKIJ Ekran}.rtl.post-title{font-family:UKIJ Ekran}.reading-progress-bar{position:fixed;top:0;left:0;z-index:9999;display:block;width:0;height:2px;background:#37c6c0}.sidebar{position:fixed;right:0;top:0;bottom:0;width:0;z-index:1040;box-shadow:inset 0 2px 6px #000;background:#222;-webkit-transform:translateZ(0)}.sidebar .exturl,.sidebar a{color:#999;border-bottom-color:#555}.sidebar .exturl:hover,.sidebar a:hover{color:#eee}@media (min-width:768px) and (max-width:991px){.sidebar{display:none!important}}@media (max-width:767px){.sidebar{display:none!important}}.sidebar-inner{position:relative;padding:20px 10px;color:#999;text-align:center}.site-overview-wrap{overflow:hidden}.site-overview{overflow-y:auto;overflow-x:hidden}.sidebar-toggle{position:fixed;right:30px;bottom:45px;width:14px;height:14px;padding:5px;background:#222;line-height:0;z-index:1050;cursor:pointer;-webkit-transform:translateZ(0)}@media (min-width:768px) and (max-width:991px){.sidebar-toggle{display:none!important}}@media (max-width:767px){.sidebar-toggle{display:none!important}}.sidebar-toggle-line{position:relative;display:inline-block;vertical-align:top;height:2px;width:100%;background:#fff;margin-top:3px}.sidebar-toggle-line:first-child{margin-top:0}.site-author-image{display:block;margin:0 auto;padding:2px;max-width:120px;height:auto;border:1px solid #eee;opacity:1}img:hover{-webkit-transform:rotateZ(360deg);-moz-transform:rotateZ(360deg);-ms-transform:rotate(360deg);-webkit-transform:rotateZ(360deg);-moz-transform:rotateZ(360deg);-ms-transform:rotateZ(360deg);-o-transform:rotateZ(360deg);transform:rotateZ(360deg)}.site-author-name{margin:0;text-align:center;color:#222;font-weight:600}.site-description{margin-top:0;text-align:center;font-size:13px;color:#999}.site-state{overflow:hidden;line-height:1.4;white-space:nowrap;text-align:center}.site-state-item{display:inline-block;padding:0 15px;border-left:1px solid #eee}.site-state-item:first-child{border-left:none}.site-state-item a{border-bottom:none}.site-state-item-count{display:block;text-align:center;color:inherit;font-weight:600;font-size:16px}.site-state-item-name{font-size:13px;color:#999}.feed-link{margin-top:20px}.feed-link a{display:inline-block;padding:0 15px;color:#fc6423;border:1px solid #fc6423;border-radius:4px}.feed-link a i{color:#fc6423;font-size:14px}.feed-link a:hover{color:#fff;background:#fc6423}.feed-link a:hover i{color:#fff}.links-of-author{margin-top:20px}.links-of-author .exturl,.links-of-author a{display:inline-block;vertical-align:middle;margin-right:10px;margin-bottom:10px;border-bottom-color:#555;font-size:13px}.links-of-author .exturl:before,.links-of-author a:before{display:inline-block;vertical-align:middle;margin-right:3px;content:" ";width:4px;height:4px;border-radius:50%;background:#24fff9}.links-of-blogroll{font-size:13px}.links-of-blogroll-title{margin-top:20px;font-size:14px;font-weight:600}.links-of-blogroll-list{margin:0;padding:0;list-style:none}.links-of-blogroll-item{padding:2px 10px}.links-of-blogroll-item a{max-width:280px;box-sizing:border-box;display:inline-block;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.sidebar-nav{margin:0 0 20px;padding-left:0}.sidebar-nav li{display:inline-block;cursor:pointer;border-bottom:1px solid transparent;font-size:14px;color:#555}.sidebar-nav li:hover{color:#fc6423}.page-post-detail .sidebar-nav-toc{padding:0 5px}.page-post-detail .sidebar-nav-overview{margin-left:10px}.sidebar-nav .sidebar-nav-active{color:#fc6423;border-bottom-color:#fc6423}.sidebar-nav .sidebar-nav-active:hover{color:#fc6423}.sidebar-panel{display:none}.sidebar-panel-active{display:block}.post-toc-empty{font-size:14px;color:#666}.post-toc-wrap{overflow:hidden}.post-toc{overflow:auto}.post-toc ol{margin:0;padding:0 2px 5px 10px;text-align:left;list-style:none;font-size:14px}.post-toc ol>ol{padding-left:0}.post-toc ol a{transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s;transition-property:all;color:#666;border-bottom-color:#ccc}.post-toc ol a:hover{color:#000;border-bottom-color:#000}.post-toc .nav-item{overflow:hidden;text-overflow:ellipsis;line-height:1.8}.post-toc .nav .nav-child{display:none}.post-toc .nav .active>.nav-child{display:block}.post-toc .nav .active-current>.nav-child{display:block}.post-toc .nav .active-current>.nav-child>.nav-item{display:block}.post-toc .nav .active>a{color:#fc6423;border-bottom-color:#fc6423}.post-toc .nav .active-current>a{color:#fc6423}.post-toc .nav .active-current>a:hover{color:#fc6423}.footer{font-size:14px;color:#999}.footer img{border:none}.footer-inner{text-align:center}.with-love{display:inline-block;margin:0 5px;color:grey}.powered-by,.theme-info{display:inline-block}.cc-license{margin-top:10px;text-align:center}.cc-license .cc-opacity{opacity:.7;border-bottom:none}.cc-license .cc-opacity:hover{opacity:.9}.cc-license img{display:inline-block}@-moz-keyframes iconAnimate{0%,100%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%,30%{-webkit-transform:scale(.9);-moz-transform:scale(.9);-ms-transform:scale(.9);-o-transform:scale(.9);transform:scale(.9)}20%,40%,60%,80%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}50%,70%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}}@-webkit-keyframes iconAnimate{0%,100%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%,30%{-webkit-transform:scale(.9);-moz-transform:scale(.9);-ms-transform:scale(.9);-o-transform:scale(.9);transform:scale(.9)}20%,40%,60%,80%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}50%,70%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}}@-o-keyframes iconAnimate{0%,100%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%,30%{-webkit-transform:scale(.9);-moz-transform:scale(.9);-ms-transform:scale(.9);-o-transform:scale(.9);transform:scale(.9)}20%,40%,60%,80%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}50%,70%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}}@keyframes iconAnimate{0%,100%{-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}10%,30%{-webkit-transform:scale(.9);-moz-transform:scale(.9);-ms-transform:scale(.9);-o-transform:scale(.9);transform:scale(.9)}20%,40%,60%,80%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}50%,70%{-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}}.post-spread{margin-top:20px;text-align:center}.jiathis_style{display:inline-block}.jiathis_style a{border:none}.fa{font-family:FontAwesome!important}.post-spread{margin-top:20px;text-align:center}.bdshare-slide-button-box a{border:none}.bdsharebuttonbox{display:inline-block}.bdsharebuttonbox a{border:none}.local-search-pop-overlay{position:fixed;width:100%;height:100%;top:0;left:0;z-index:2080;background-color:rgba(0,0,0,.3)}.local-search-popup{display:none;position:fixed;top:10%;left:50%;margin-left:-350px;width:700px;height:80%;padding:0;background:#fff;color:#333;z-index:9999;border-radius:5px}@media (max-width:767px){.local-search-popup{padding:0;top:0;left:0;margin:0;width:100%;height:100%;border-radius:0}}.local-search-popup ul.search-result-list{padding:0;margin:0 5px}.local-search-popup p.search-result{border-bottom:1px dashed #ccc;padding:5px 0}.local-search-popup a.search-result-title{font-weight:700;font-size:16px}.local-search-popup .search-keyword{border-bottom:1px dashed red;font-weight:700;color:red}.local-search-popup .local-search-header{padding:5px;height:36px;background:#f5f5f5;border-top-left-radius:5px;border-top-right-radius:5px}.local-search-popup #local-search-result{overflow:auto;position:relative;padding:5px 25px;height:calc(100% - 55px)}.local-search-popup .local-search-input-wrapper{display:inline-block;width:calc(100% - 90px);height:36px;line-height:36px;padding:0 5px}.local-search-popup .local-search-input-wrapper input{padding:8px 0;height:20px;display:block;width:100%;outline:0;border:none;background:0 0;vertical-align:middle}.local-search-popup .popup-btn-close,.local-search-popup .search-icon{display:inline-block;font-size:18px;color:#999;height:36px;width:18px;padding-left:10px;padding-right:10px}.local-search-popup .search-icon{float:left}.local-search-popup .popup-btn-close{border-left:1px solid #eee;float:right;cursor:pointer}.local-search-popup #no-result{position:absolute;left:50%;top:50%;-webkit-transform:translate(-50%,-50%);-webkit-transform:translate(-50%,-50%);-moz-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);-o-transform:translate(-50%,-50%);transform:translate(-50%,-50%);color:#ccc}.page-pv,.site-pv,.site-uv{display:inline-block}.page-pv .busuanzi-value,.site-pv .busuanzi-value,.site-uv .busuanzi-value{margin:0 5px}.popular-posts-header{margin-top:60px;margin-bottom:10px;font-size:24px;border-bottom:1px solid #eee;display:block}ul.popular-posts{padding:0}ul.popular-posts .popular-posts-item{margin-left:2em}ul.popular-posts .popular-posts-item .popular-posts-title{font-weight:400;font-size:14px;margin:0;line-height:2.4}.page-archive .archive-page-counter{position:relative;top:3px;left:20px}@media (max-width:767px){.page-archive .archive-page-counter{top:5px}}.page-archive .posts-collapse .archive-move-on{position:absolute;top:11px;left:0;margin-left:-6px;width:10px;height:10px;opacity:.5;background:#555;border:1px solid #fff;border-radius:50%}.category-all-page .category-all-title{text-align:center}.category-all-page .category-all{margin-top:20px}.category-all-page .category-list{margin:0;padding:0;list-style:none}.category-all-page .category-list-item{margin:5px 10px}.category-all-page .category-list-count{color:#bbb}.category-all-page .category-list-count:before{display:inline;content:" ("}.category-all-page .category-list-count:after{display:inline;content:") "}.category-all-page .category-list-child{padding-left:10px}#schedule ul#event-list{padding-left:30px}#schedule ul#event-list hr{margin:20px 0 45px 0!important;background:#222}#schedule ul#event-list hr:after{display:inline-block;content:'NOW';background:#222;color:#fff;font-weight:700;text-align:right;padding:0 5px}#schedule ul#event-list li.event{margin:20px 0;background:#f9f9f9;padding-left:10px;min-height:40px}#schedule ul#event-list li.event h2.event-summary{margin:0;padding-bottom:3px}#schedule ul#event-list li.event h2.event-summary:before{display:inline-block;font-family:FontAwesome;font-size:8px;content:'\f111';vertical-align:middle;margin-right:25px;color:#bbb}#schedule ul#event-list li.event span.event-relative-time{display:inline-block;font-size:12px;font-weight:400;padding-left:12px;color:#bbb}#schedule ul#event-list li.event span.event-details{display:block;color:#bbb;margin-left:56px;padding-top:3px;padding-bottom:6px;text-indent:-24px;line-height:18px}#schedule ul#event-list li.event span.event-details:before{text-indent:0;display:inline-block;width:14px;font-family:FontAwesome;text-align:center;margin-right:9px;color:#bbb}#schedule ul#event-list li.event span.event-details.event-location:before{content:'\f041'}#schedule ul#event-list li.event span.event-details.event-duration:before{content:'\f017'}#schedule ul#event-list li.event-past{background:#fcfcfc}#schedule ul#event-list li.event-past>*{opacity:.6}#schedule ul#event-list li.event-past h2.event-summary{color:#bbb}#schedule ul#event-list li.event-past h2.event-summary:before{color:#dfdfdf}#schedule ul#event-list li.event-now{background:#222;color:#fff;padding:15px 0 15px 10px}#schedule ul#event-list li.event-now h2.event-summary:before{-webkit-transform:scale(1.2);-moz-transform:scale(1.2);-ms-transform:scale(1.2);-o-transform:scale(1.2);transform:scale(1.2);color:#fff;animation:dot-flash 1s alternate infinite ease-in-out}#schedule ul#event-list li.event-now *{color:#fff!important}@-moz-keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@-webkit-keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@-o-keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}@keyframes dot-flash{from{opacity:1;-webkit-transform:scale(1.1);-moz-transform:scale(1.1);-ms-transform:scale(1.1);-o-transform:scale(1.1);transform:scale(1.1)}to{opacity:0;-webkit-transform:scale(1);-moz-transform:scale(1);-ms-transform:scale(1);-o-transform:scale(1);transform:scale(1)}}.page-post-detail .sidebar-toggle-line{background:#fc6423}.page-post-detail .comments{overflow:hidden}ul.breadcrumb{list-style:none;margin:1em 0;padding:0 2em;text-align:center;font-size:12px}ul.breadcrumb li{display:inline}ul.breadcrumb li+li:before{padding:.5em;font-weight:400;content:"/\00a0"}ul.breadcrumb li+li:last-child{font-weight:700}.header{position:relative;margin:0 auto;width:75%}@media (min-width:768px) and (max-width:991px){.header{width:auto}}@media (max-width:767px){.header{width:auto}}.header-inner{position:absolute;top:0;overflow:hidden;padding:0;width:240px;background:#fff;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12);border-radius:initial}@media (min-width:1600px){.container .header-inner{width:240px}}@media (min-width:768px) and (max-width:991px){.header-inner{position:relative;width:auto;border-radius:initial}}@media (max-width:767px){.header-inner{position:relative;width:auto;border-radius:initial}}.main:after,.main:before{content:" ";display:table}.main:after{clear:both}@media (min-width:768px) and (max-width:991px){.main{padding-bottom:100px}}@media (max-width:767px){.main{padding-bottom:100px}}.container .main-inner{width:75%}@media (min-width:768px) and (max-width:991px){.container .main-inner{width:auto}}@media (max-width:767px){.container .main-inner{width:auto}}.content-wrap{float:right;box-sizing:border-box;padding:40px;width:calc(100% - 252px);background:#fff;min-height:700px;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12);border-radius:initial}@media (min-width:768px) and (max-width:991px){.content-wrap{width:100%;padding:20px;border-radius:initial}}@media (max-width:767px){.content-wrap{width:100%;padding:20px;min-height:auto;border-radius:initial}}.sidebar{position:static;float:left;margin-top:300px;width:240px;background:#eee;box-shadow:none}@media (min-width:768px) and (max-width:991px){.sidebar{display:none}}@media (max-width:767px){.sidebar{display:none}}.sidebar-toggle{display:none}.footer-inner{width:75%;padding-left:260px}@media (min-width:768px) and (max-width:991px){.footer-inner{width:auto;padding-left:0!important;padding-right:0!important}}@media (max-width:767px){.footer-inner{width:auto;padding-left:0!important;padding-right:0!important}}.sidebar-position-right .header-inner{right:0}.sidebar-position-right .content-wrap{float:left}.sidebar-position-right .sidebar{float:right}.sidebar-position-right .footer-inner{padding-left:0;padding-right:260px}.site-brand-wrapper{position:relative}.site-meta{padding:20px 0;color:#fff;background:#222}@media (min-width:768px) and (max-width:991px){.site-meta{box-shadow:0 0 16px rgba(0,0,0,.5)}}@media (max-width:767px){.site-meta{box-shadow:0 0 16px rgba(0,0,0,.5)}}.brand{padding:0;background:0 0}.brand:hover{color:#fff}.site-subtitle{margin:10px 10px 0;font-weight:initial}.site-search form{display:none}.site-nav{border-top:none}@media (min-width:768px) and (max-width:991px){.site-nav{display:none!important}}@media (min-width:768px) and (max-width:991px){.site-nav-on{display:block!important}}.menu .menu-item{display:block;margin:0}.menu .menu-item a{position:relative;box-sizing:border-box;padding:5px 20px;text-align:left;line-height:inherit;transition-property:background-color;transition-duration:.2s;transition-timing-function:ease-in-out;transition-delay:0s}.menu .menu-item a:hover,.menu-item-active a{background:#f9f9f9;border-bottom-color:#fff}.menu .menu-item .badge{display:inline-block;padding:2px 5px;font-weight:700;line-height:1;color:#fff;text-align:center;white-space:nowrap;vertical-align:middle;background-color:#ccc;border-radius:10px;float:right;margin:.35em 0 0 0;text-shadow:1px 1px 0 rgba(0,0,0,.1)}.menu .menu-item br{display:none}.btn-bar{background-color:#fff}.site-nav-toggle{left:20px;top:50%;-webkit-transform:translateY(-50%);-webkit-transform:translateY(-50%);-moz-transform:translateY(-50%);-ms-transform:translateY(-50%);-o-transform:translateY(-50%);transform:translateY(-50%)}@media (min-width:768px) and (max-width:991px){.site-nav-toggle{display:block}}.sub-menu{margin:0;padding:6px 0;background:#fff!important;border-bottom:1px solid #ddd}.sub-menu .menu-item{display:inline-block!important}.sub-menu .menu-item a{padding:initial!important;margin:5px 10px}.sub-menu .menu-item a:hover{background:initial!important;color:#fc6423}.sub-menu .menu-item-active a{background:#fff!important;color:#fc6423;border-bottom-color:#fc6423}.sub-menu .menu-item-active a:hover{background:#fff!important;border-bottom-color:#fc6423}.use-motion .sidebar .motion-element{opacity:1}.sidebar{margin-left:-100%;right:auto;bottom:auto;-webkit-transform:none}.sidebar-inner{box-sizing:border-box;width:240px;color:#555;background:#fff;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12),0 -1px .5px 0 rgba(0,0,0,.09);border-radius:initial;opacity:0}.sidebar-inner.affix{position:fixed;top:12px}.sidebar-inner.affix-bottom{position:absolute}.site-overview{text-align:left}.site-author:after,.site-author:before{content:" ";display:table}.site-author:after{clear:both}.sidebar .exturl,.sidebar a{color:#555}.sidebar .exturl:hover,.sidebar a:hover{color:#222}.site-state-item{padding:0 10px}.links-of-author-item .exturl:before,.links-of-author-item a:before{display:none}.links-of-author-item .exturl,.links-of-author-item a{border-bottom:none;text-decoration:underline}.feed-link{border-top:1px dotted #ccc;border-bottom:1px dotted #ccc;text-align:center}.feed-link a{display:block;color:#fc6423;border:none}.feed-link a:hover{background:0 0;color:#e34603}.feed-link a:hover i{color:#e34603}.links-of-author{display:flex;flex-wrap:wrap;justify-content:center}.links-of-author .exturl{font-size:13px}.links-of-author-item{margin:5px 0 0;width:50%}.links-of-author-item .exturl,.links-of-author-item a{max-width:216px;box-sizing:border-box;display:inline-block;margin-right:0;margin-bottom:0;padding:0 5px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.links-of-author-item .exturl,.links-of-author-item a{display:block;text-decoration:none}.links-of-author-item .exturl:hover,.links-of-author-item a:hover{border-radius:4px;background:#eee}.links-of-author-item .fa{margin-right:2px;font-size:16px}.links-of-author-item .fa-globe{font-size:15px}.links-of-blogroll{text-align:center;margin-top:20px;padding:3px 0 0;border-top:1px dotted #ccc}.links-of-blogroll-title{margin-top:0}.links-of-blogroll-item{padding:0}.links-of-blogroll-inline:after,.links-of-blogroll-inline:before{content:" ";display:table}.links-of-blogroll-inline:after{clear:both}.links-of-blogroll-inline .links-of-blogroll-item{margin:5px 0 0;width:50%;display:inline-block;width:unset}.links-of-blogroll-inline .links-of-blogroll-item .exturl,.links-of-blogroll-inline .links-of-blogroll-item a{max-width:216px;box-sizing:border-box;display:inline-block;margin-right:0;margin-bottom:0;padding:0 5px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}.content-wrap{padding:initial;background:initial;box-shadow:initial;border-radius:initial}.post-block{padding:40px;background:#fff;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12);border-radius:initial}#posts>article+article .post-block{margin-top:12px;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12),0 -1px .5px 0 rgba(0,0,0,.09);border-radius:initial}.comments{padding:40px;margin:initial;margin-top:12px;background:#fff;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12),0 -1px .5px 0 rgba(0,0,0,.09);border-radius:initial}.posts-expand{padding-top:initial}.post-nav-divider{width:4%}.post-nav-item{width:48%}.post-eof,.post-spread{display:none!important}.pagination{margin:12px 0 0;border-top:initial;background:#fff;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12),0 -1px .5px 0 rgba(0,0,0,.09);border-radius:initial;padding:10px 0 10px}.pagination .next,.pagination .page-number,.pagination .prev{margin-bottom:initial;top:initial}.main{padding-bottom:initial}.footer{bottom:auto}.sub-menu{border-bottom:initial!important;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12)}.sub-menu+#content>#posts .post-block{box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12),0 -1px .5px 0 rgba(0,0,0,.09);margin-top:12px}@media (min-width:768px) and (max-width:991px){.sub-menu+#content>#posts .post-block{margin-top:10px}}@media (max-width:767px){.sub-menu+#content>#posts .post-block{margin-top:8px}}.post-header h1,.post-header h2{margin:initial}.posts-expand .post-title-link{line-height:inherit}.posts-expand .post-title{font-size:1.7em}.post-body h1{font-size:1.6em;border-bottom:1px solid #eee}.post-body h2{font-size:1.45em;border-bottom:1px solid #eee}.post-body h3{font-size:1.3em;border-bottom:1px solid #eee}.post-body h4{font-size:1.2em;border-bottom:1px dotted #eee}.post-body h5{font-size:1.07em}.post-body h6{font-size:1.03em}@media (min-width:768px) and (max-width:991px){.content-wrap{padding:10px}.posts-expand{margin:initial}.posts-expand .post-button{margin-top:20px}.post-block{padding:20px;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12),0 -1px .5px 0 rgba(0,0,0,.09);border-radius:initial}#posts>article+article .post-block{margin-top:10px}.comments{margin-top:10px;padding:10px 20px}.pagination{margin:10px 0 0}}@media (max-width:767px){.content-wrap{padding:8px}.posts-expand{margin:initial}.posts-expand .post-button{margin-top:12px}.posts-expand img{padding:initial!important}.post-block{padding:12px;min-height:auto;box-shadow:0 2px 2px 0 rgba(0,0,0,.12),0 3px 1px -2px rgba(0,0,0,.06),0 1px 5px 0 rgba(0,0,0,.12),0 -1px .5px 0 rgba(0,0,0,.09);border-radius:initial}#posts>article+article .post-block{margin-top:8px}.comments{margin-top:8px;padding:0 12px}.pagination{margin:8px 0 0}}</style><noscript><style type="text/css">.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.logo-line-after i{right:initial}</style></noscript><script>function loadCss(l){var d=document,h=d.head,s=d.createElement('link');s.rel='stylesheet';s.href=l;!function e(f){if (d.body)return f();setTimeout(function(){e(f)})}(function(){h.appendChild(s);});}loadCss('https://cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css');loadCss('https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css');loadCss('https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css');</script><noscript><link rel="stylesheet" href="https://cdn.bootcss.com/pace/1.0.2/themes/blue/pace-theme-flash.min.css"><link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">phantom9999的博客</span> <span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-php-devel"><a href="/categories/php-devel" rel="section"><i class="menu-item-icon fa fa-fw fa-university"></i><br>php开发</a></li><li class="menu-item menu-item-cpp-devel"><a href="/categories/cpp-devel" rel="section"><i class="menu-item-icon fa fa-fw fa-university"></i><br>c++开发</a></li><li class="menu-item menu-item-essay"><a href="/categories/essay" rel="section"><i class="menu-item-icon fa fa-fw fa-university"></i><br>随笔</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签<span class="badge">24</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类<span class="badge">6</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档<span class="badge">131</span></a></li><li class="menu-item menu-item-php-internal"><a href="/categories/php-internal/" rel="section"><i class="menu-item-icon fa fa-fw fa-university"></i><br>php内核解析收集</a></li><li class="menu-item menu-item-php-ext"><a href="/categories/php-ext/" rel="section"><i class="menu-item-icon fa fa-fw fa-university"></i><br>php拓展开发收集</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><div class="reading-progress-bar"></div><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://phantom9999.github.io/posts/3610f3f6.html"><span hidden="" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="phantom9999"><meta itemprop="description" content="cpp,php相关的个人博客"><meta itemprop="image" content="/images/avatar.gif"></span><span hidden="" itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="phantom9999的博客"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">9 PHP中的资源类型</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-02-01 20:07:09" itemprop="dateCreated datePublished" datetime="2018-02-01T20:07:09+00:00">2018-02-01</time> </span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/php-ext/" itemprop="url" rel="index"><span itemprop="name">php_ext</span></a></span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="9-PHP中的资源类型"><a href="#9-PHP中的资源类型" class="headerlink" title="9 PHP中的资源类型"></a>9 PHP中的资源类型</h1><p>截止到现在，我们已经熟悉了PHP语言中的字符串、数字、布尔以及数组的数据类型了，接下来，我们将接触另外一种PHP独特的数据类型——资源（Resource）。</p><h1 id="9-1-PHP中的资源类型"><a href="#9-1-PHP中的资源类型" class="headerlink" title="9.1 PHP中的资源类型"></a>9.1 PHP中的资源类型</h1><div class="tip-common"><br>讲述之前，先描述下{资源}类型在内核中的结构：<br></div><br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//每一个资源都是通过它来实现的。</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_rsrc_list_entry</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	<span class="keyword">void</span> *ptr;</span><br><span class="line">	<span class="keyword">int</span> type;</span><br><span class="line">	<span class="keyword">int</span> refcount;</span><br><span class="line">}zend_rsrc_list_entry;</span><br></pre></td></tr></tbody></table></figure><br><br>在真实世界中，我们经常需要操作一些不好用标量值表现的数据，比如某个文件的句柄，而对于C来说，它也仅仅是个指针而已。<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	FILE *fd;</span><br><span class="line">	fd = fopen(<span class="string">"/home/jdoe/.plan"</span>, <span class="string">"r"</span>);</span><br><span class="line">	fclose(fd);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br><br>C语言中stdio的文件描述符(file descriptor)是与每个打开的文件相匹配的一个变量，它实际上是一个FILE类型的指针，它将在程序与硬件交互通讯时使用。我们可以使用fopen函数来打开一个文件获取句柄，之后只需把这个句柄传递给feof()、fread()、fwrite()、fclose()之类的函数，便可以对这个文件进行后续操作了。既然这个数据在C语言中就无法直接用标量数据来表示，那我们如何对其进行封装才能保证用户在PHP语言中也能使用到它呢？这便是PHP中资源类型变量的作用了！所以它也是通过一个zval结构来进行封装的。<br>资源类型的实现并不复杂，它的值其实仅仅是一个整数，内核将根据这个整数值去一个类似资源池的地方寻找最终需要的数据。<br>### 资源类型变量的使用<br>资源类型的变量在实现中也是有类型区分的！为了区分不同类型的资源，比如一个是文件句柄，一个是mysql链接，我们需要为其赋予不同的分类名称。首先，我们需要先把这个分类添加到程序中去。这一步的操作可以在MINIT中来做：<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_SAMPLE_DESCRIPTOR_RES_NAME <span class="meta-string">"山寨文件描述符"</span></span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> le_sample_descriptor;</span><br><span class="line">ZEND_MINIT_FUNCTION(sample)</span><br><span class="line">{</span><br><span class="line">	le_sample_descriptor = zend_register_list_destructors_ex(<span class="literal">NULL</span>, <span class="literal">NULL</span>, PHP_SAMPLE_DESCRIPTOR_RES_NAME,module_number);</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">//附加资料</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> register_list_destructors(ld, pld) zend_register_list_destructors((void (*)(void *))ld, (void (*)(void *))pld, module_number);</span></span><br><span class="line"><span class="function">ZEND_API <span class="keyword">int</span> <span class="title">zend_register_list_destructors</span><span class="params">(<span class="keyword">void</span> (*ld)(<span class="keyword">void</span> *), <span class="keyword">void</span> (*pld)(<span class="keyword">void</span> *), <span class="keyword">int</span> module_number)</span></span>;</span><br><span class="line"><span class="function">ZEND_API <span class="keyword">int</span> <span class="title">zend_register_list_destructors_ex</span><span class="params">(<span class="keyword">rsrc_dtor_func_t</span> ld, <span class="keyword">rsrc_dtor_func_t</span> pld, <span class="keyword">char</span> *type_name, <span class="keyword">int</span> module_number)</span></span>;</span><br></pre></td></tr></tbody></table></figure><br><br>接下来，我们把定义好的MINIT阶段的函数添加到扩展的module_entry里去，只需要把原来的”NULL, /<em> MINIT </em>/“一行替换掉即可：<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZEND_MINIT(sample), <span class="comment">/* MINIT */</span></span><br></pre></td></tr></tbody></table></figure><br><br>ZEND_MINIT_FUNCTION()宏用来帮助我们定义MINIT阶段的函数，这我们已经在第一章里描述过了，但将会在第12章和第三章有更详细的描述。<br>What’s important to know at this juncture is that the MINIT method is executed once when your extension is first loaded and before any requests have been received. Here you’ve used that opportunity to register destructor functionsthe NULL values, which you’ll change soon enoughfor a resource type that will be thereafter known by a unique integer ID.<br>看到zend_register_list_destructors_ex()函数，你肯定会想是不是也存在一个zend_register_list_destructors()函数呢？是的，确实有这么一个函数，它的参数中比前者少了资源类别的名称。那这两这的区别在哪呢？<br><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eaco $re_1;</span><br><span class="line"><span class="comment">//resource(4) of type (山寨版File句柄)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $re_2;</span><br><span class="line"><span class="comment">//resource(4) of type (Unknown)</span></span><br></pre></td></tr></tbody></table></figure><br><br>### 创建资源<br>我们在上面向内核中注册了一种新的资源类型，下一步便可以创建这种类型的资源变量了。接下来让我们简单的重新实现一个fopen函数，现在叫sample_open：<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(sample_fopen)</span><br><span class="line">{</span><br><span class="line">	FILE *fp;</span><br><span class="line">	<span class="keyword">char</span> *filename, *mode;</span><br><span class="line">	<span class="keyword">int</span> filename_len, mode_len;</span><br><span class="line">	<span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"ss"</span>,&amp;filename, &amp;filename_len,&amp;mode, &amp;mode_len) == FAILURE)</span><br><span class="line">    {</span><br><span class="line">		RETURN_NULL();</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> (!filename_len || !mode_len)</span><br><span class="line">	{</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Invalid filename or mode length"</span>);</span><br><span class="line">			RETURN_FALSE;</span><br><span class="line">	}</span><br><span class="line">	fp = fopen(filename, mode);</span><br><span class="line">	<span class="keyword">if</span> (!fp)</span><br><span class="line">	{</span><br><span class="line">		php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Unable to open %s using mode %s"</span>,filename, mode);</span><br><span class="line">			RETURN_FALSE;</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">//将fp添加到资源池中去，并标记它为le_sample_descriptor类型的。</span></span><br><span class="line">	ZEND_REGISTER_RESOURCE(return_value,fp,le_sample_descriptor);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br><br>如果前面章节的知识你都看过的话，应该可以猜出最后一行代码是干啥的了。它创建了一个新的le_sample_descriptor类型的资源，此资源的值是fp，另外它把这个资源加入到一个存储资源的HashTable中，并把此资源在其中对应的数字Key赋给return_value。<br><div class="tip-common"><br>资源并不局限于文件句柄，我们可以申请一块内存，并且指向它的指针来作为一种资源。所以资源可以对应任意类型的数据。<br></div><br>### 销毁资源<br>世间万物皆有喜有悲，有生有灭，到了我们探讨如何销毁资源的时候了。最简单的一种莫过于仿照fclose写一个sample_close()函数，在它里面实现对某种{资源：专指PHP的资源类型变量代表的值}的释放。<br><br>但是，如果用户端的脚本通过unset()函数来释放某个资源类型的变量会如何呢？它们可不知道它的值最终对应一个FILE<em>指针啊，所以也无法使用fclose()函数来释放它，这个FILE</em>句柄很有可能会一直存在于内存中，直到PHP程序挂掉，由OS来回收。但在一个平常的Web环境中，我们的服务器都会长时间运行的。<br>难道就没有解决方案了吗？当然不是，谜底就在那个NULL参数里，就是我们在上面为了生成新的资源类型，调用的zend_register_list_destructors_ex()函数的第一个参数和第二个参数。这两个参数都各自代表一个回调参数。第一个回调函数会在脚本中的相应类型的资源变量被释放掉的时候触发，比如作用域结束了，或者被unset()掉了。<br><br>第二个回调函数则是用在一个类似于长链接类型的资源上的，也就是这个资源创建后会一直存在于内存中，而不会在request结束后被释放掉。它将会在Web服务器进程终止时调用，相当于在MSHUTDOWN阶段被内核调用。有关persistent resources的事宜，我们将在下一节里详述。<br><br>我们先来定义第一种回调函数。<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_sample_descriptor_dtor</span><span class="params">(zend_rsrc_list_entry *rsrc TSRMLS_DC)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    FILE *fp = (FILE*)rsrc-&gt;ptr;</span><br><span class="line">    fclose(fp);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br><br>然后用它替换掉zend_register_list_destructors_ex()函数的第一个参数NULL：<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">le_sample_descriptor = zend_register_list_destructors_ex(</span><br><span class="line">        php_sample_descriptor_dtor,</span><br><span class="line">        <span class="literal">NULL</span>,</span><br><span class="line">        PHP_SAMPLE_DESCRIPTOR_RES_NAME,</span><br><span class="line">        module_number);</span><br></pre></td></tr></tbody></table></figure><br><br>现在，如果脚本中得到了一个上述类型的资源变量，当它被unset的时候，或者因为作用域执行完被内核释放掉的时候都会被内核调用底层的php_sample_descriptor_dtor来预处理它。这样一来，貌似我们根本就不需要sample_close()函数了！<br><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $fp = sample_fopen(<span class="string">"/home/jdoe/notes.txt"</span>, <span class="string">"r"</span>);</span><br><span class="line">  <span class="keyword">unset</span>($fp);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><br><br>unset($fp)执行后，内核会自动的调用php_sample_descriptor_dtor函数来清理这个变量对应的一些数据。<br>当然，事情绝对没有这么简单，让我们先记住这个疑问，继续往下看。<br>### Decoding Resources<br>我们把资源变量比作书签，可如果仅有书签的话绝对没有任何作用啊！我们需要通过书签找到相应的页才行。对于资源变量，我们必须能够通过它找到相应的最终数据才行！<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ZEND_FUNCTION(sample_fwrite)</span><br><span class="line">{</span><br><span class="line">	FILE *fp;</span><br><span class="line">	zval *file_resource;</span><br><span class="line">	<span class="keyword">char</span> *data;</span><br><span class="line">	<span class="keyword">int</span> data_len;</span><br><span class="line">	<span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"rs"</span>,&amp;file_resource, &amp;data, &amp;data_len) == FAILURE )</span><br><span class="line">	{</span><br><span class="line">		RETURN_NULL();</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">/* Use the zval* to verify the resource type and</span></span><br><span class="line"><span class="comment">	 * retrieve its pointer from the lookup table */</span></span><br><span class="line">	ZEND_FETCH_RESOURCE(fp,FILE*,&amp;file_resource,<span class="number">-1</span>,PHP_SAMPLE_DESCRIPTOR_RES_NAME,le_sample_descriptor);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write the data, and</span></span><br><span class="line"><span class="comment">	 * return the number of bytes which were</span></span><br><span class="line"><span class="comment">	 * successfully written to the file */</span></span><br><span class="line">	RETURN_LONG(fwrite(data, <span class="number">1</span>, data_len, fp));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br><br>zend_parse_parameters()函数中的r占位符代表着接收资源类型的变量，它的载体是一个zval<em>。然后让我们看一下ZEND_FETCH_RESOURCE()宏函数。<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_FETCH_RESOURCE(rsrc, rsrc_type, passed_id,default_id, resource_type_name, resource_type)</span></span><br><span class="line">    rsrc = (rsrc_type) zend_fetch_resource(passed_id TSRMLS_CC,default_id, resource_type_name, <span class="literal">NULL</span>,<span class="number">1</span>, resource_type);</span><br><span class="line">    ZEND_VERIFY_RESOURCE(rsrc);</span><br><span class="line"></span><br><span class="line"><span class="comment">//在我们的例子中，它是这样的：</span></span><br><span class="line">fp = (FILE*) zend_fetch_resource(&amp;file_descriptor TSRMLS_CC, <span class="number">-1</span>,PHP_SAMPLE_DESCRIPTOR_RES_NAME, <span class="literal">NULL</span>,<span class="number">1</span>, le_sample_descriptor);</span><br><span class="line"><span class="keyword">if</span> (!fp)</span><br><span class="line">{</span><br><span class="line">    RETURN_FALSE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><br><br>zend_fetch_resource()是对zend_hash_find()的一层封装，它使用一个数字key去一个保存各种{资源}的HashTable中寻找最终需要的数据，找到之后，我们用ZEND_VERIFY_RESOURCE()宏函数校验一下这个数据。从上面的代码中我们可以看出，NULL、0是绝对不能作为一种资源的。<br>上面的例子中，zend_fetch_resource()函数首先获取le_sample_descriptor代表的资源类型，如果资源不存在或者接收的zval不是一个资源类型的变量，它便会返回NULL，并抛出相应的错误信息。<br>最后的ZEND_VERIFY_RESOURCE()宏函数如果检测到错误，便会自动返回，使我们可以从错误检测中脱离出来，更加专注于程序的主逻辑。现在我们已经获取到了相应的FILE</em>了，下面就用fwrite()向其中写入点数据吧！。<p><br></p><div class="tip-common"><br>To avoid having zend_fetch_resource() generate an error on failure, simply pass NULL for the resource_type_name parameter. Without a meaningful error message to display, zend_fetch_resource() will fail silently instead.<br></div><p>我们也可以通过另一种方法来获取我们最终想要的数据。<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ZEND_FUNCTION(sample_fwrite)</span><br><span class="line">{</span><br><span class="line">    FILE *fp;</span><br><span class="line">    zval *file_resource;</span><br><span class="line">    <span class="keyword">char</span> *data;</span><br><span class="line">    <span class="keyword">int</span> data_len, rsrc_type;</span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"rs"</span>,&amp;file_resource, &amp;data, &amp;data_len) == FAILURE ) {</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    }</span><br><span class="line">    fp = (FILE*)zend_list_find(Z_RESVAL_P(file_resource),&amp;rsrc_type);</span><br><span class="line">    <span class="keyword">if</span> (!fp || rsrc_type != le_sample_descriptor) {</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Invalid resource provided"</span>);</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    }</span><br><span class="line">    RETURN_LONG(fwrite(data, <span class="number">1</span>, data_len, fp));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>可以根据自己习惯来选择到底使用哪一种形式，不过推荐使用ZEND_FETCH_RESOURCE()宏函数。</p><h3 id="Forcing-Destruction"><a href="#Forcing-Destruction" class="headerlink" title="Forcing Destruction"></a>Forcing Destruction</h3><p>在上面我们还有个疑问没有解决，就是类似于我们上面实现的unset($fp)真的是万能的么？当然不是，看一下下面的代码：<br></p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  $fp = sample_fopen(<span class="string">"/home/jdoe/world_domination.log"</span>, <span class="string">"a"</span>);</span><br><span class="line">  $evil_log = $fp;</span><br><span class="line">  <span class="keyword">unset</span>($fp);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>这次，$fp和$evil_log共用一个zval，虽然$fp被释放了，但是它的zval并不会被释放，因为$evil_log还在用着。也就是说，现在$evil_log代表的文件句柄仍然是可以写入的！所以为了避免这种错误，真的需要我们手动来close it！sample_close()函数是必须存在的！<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(sample_fclose)</span><br><span class="line">{</span><br><span class="line">    FILE *fp;</span><br><span class="line">    zval *file_resource;</span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"r"</span>,&amp;file_resource) == FAILURE ) {</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* While it's not necessary to actually fetch the</span></span><br><span class="line"><span class="comment">     * FILE* resource, performing the fetch provides</span></span><br><span class="line"><span class="comment">     * an opportunity to verify that we are closing</span></span><br><span class="line"><span class="comment">     * the correct resource type. */</span></span><br><span class="line">    ZEND_FETCH_RESOURCE(fp, FILE*, &amp;file_resource, <span class="number">-1</span>,PHP_SAMPLE_DESCRIPTOR_RES_NAME, le_sample_descriptor);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Force the resource into self-destruct mode */</span></span><br><span class="line">    zend_hash_index_del(&amp;EG(regular_list),Z_RESVAL_P(file_resource));</span><br><span class="line">    RETURN_TRUE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>这个删除操作也再次说明了资源数据是保存在HashTable中的。虽然我们可以通过zend_hash_index_find()或者zend_hash_next_index_insert()之类的函数操作这个储存资源的HashTable，但这绝不是一个好主意，因为在后续的版本中，PHP可能会修改有关这一部分的实现方式，到那时上述方法便不起作用了，所以为了更好的兼容性，请使用标准的宏函数或者api函数。<br>当我们在EG(regular_list)这个HashTable中删除数据的时候，回调用一个dtor函数，它根据资源变量的类别来调用相应的dtor函数实现，就是我们调用zend_register_list_destructors_ex()函数时的第一个参数。</p><div class="tip-common">在很多地方，我们都会看到一个专门用来删除的zend_list_delete()宏函数，因为它考虑了资源数据自己的引用计数，所以我们将在后面的章节中介绍它。</div><h1 id="9-2-PHP中的资源类型"><a href="#9-2-PHP中的资源类型" class="headerlink" title="9.2 PHP中的资源类型"></a>9.2 PHP中的资源类型</h1><p>通常情况下，像{资源}这类复合类型的数据都会占用大量的硬件资源，比如内存、CPU以及网络带宽。对于使用频率超级高的数据库链接，我们可以获取一个长链接，使其不会在脚本结束后自动销毁，一旦创建便可以在各个请求中直接使用，从而减少每次创建它的消耗。Mysql的长链接在PHP内核中其实就是一种持久{资源}。<br>Memory Allocation<br>前面的章节里我们接触了emalloc()之类的以e开头的内存管理函数，通过它们申请的内存都会被内核自动的进行垃圾回收的操作。而对于一个持久{资源}来说，我们是绝对不希望它在脚本结束后被回收的。</p><p>假设我们需要在我们的{资源}中同时保存文件名和文件句柄两个数据，现在我们就需要自己定义个结构了：<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">php_sample_descriptor_data</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">    <span class="keyword">char</span> *filename;</span><br><span class="line">    FILE *fp;</span><br><span class="line">}php_sample_descriptor_data;</span><br></pre></td></tr></tbody></table></figure><p></p><p>当然，因为结构变了(之前是个FILE*)，我们之前的代码也需要跟着改动。这里还没有涉及到持久{资源}，仅仅是换了一种{资源}结构<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_sample_descriptor_dtor</span><span class="params">(zend_rsrc_list_entry *rsrc TSRMLS_DC)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    php_sample_descriptor_data *fdata = (php_sample_descriptor_data*)rsrc-&gt;ptr;</span><br><span class="line">    fclose(fdata-&gt;fp);</span><br><span class="line">    efree(fdata-&gt;filename);</span><br><span class="line">    efree(fdata);</span><br><span class="line">}</span><br><span class="line">PHP_FUNCTION(sample_fopen)</span><br><span class="line">{</span><br><span class="line">    php_sample_descriptor_data *fdata;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">char</span> *filename, *mode;</span><br><span class="line">    <span class="keyword">int</span> filename_len, mode_len;</span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"ss"</span>,&amp;filename, &amp;filename_len,&amp;mode, &amp;mode_len) == FAILURE)</span><br><span class="line">    {</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!filename_len || !mode_len) {</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Invalid filename or mode length"</span>);</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    }</span><br><span class="line">    fp = fopen(filename, mode);</span><br><span class="line">    <span class="keyword">if</span> (!fp)</span><br><span class="line">    {</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Unable to open %s using mode %s"</span>,filename, mode);</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    }</span><br><span class="line">    fdata = emalloc(<span class="keyword">sizeof</span>(php_sample_descriptor_data));</span><br><span class="line">    fdata-&gt;fp = fp;</span><br><span class="line">    fdata-&gt;filename = estrndup(filename, filename_len);</span><br><span class="line">    ZEND_REGISTER_RESOURCE(return_value, fdata,le_sample_descriptor);</span><br><span class="line">}</span><br><span class="line">PHP_FUNCTION(sample_fwrite)</span><br><span class="line">{</span><br><span class="line">    php_sample_descriptor_data *fdata;</span><br><span class="line">    zval *file_resource;</span><br><span class="line">    <span class="keyword">char</span> *data;</span><br><span class="line">    <span class="keyword">int</span> data_len;</span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"rs"</span>,&amp;file_resource, &amp;data, &amp;data_len) == FAILURE )</span><br><span class="line">    {</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    }</span><br><span class="line">    ZEND_FETCH_RESOURCE(fdata, php_sample_descriptor_data*,&amp;file_resource, <span class="number">-1</span>,PHP_SAMPLE_DESCRIPTOR_RES_NAME, le_sample_descriptor);</span><br><span class="line">    RETURN_LONG(fwrite(data, <span class="number">1</span>, data_len, fdata-&gt;fp));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p></p><div class="tip-common">我们这里没有重写sample_fclose()函数，你可以尝试着自己实现它。</div><br>现在编译运行，所有代码的结果都非常正确，我们还可以在内核中获取每个{资源}对应的文件名称了。<br><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(sample_fname)</span><br><span class="line">{</span><br><span class="line">    php_sample_descriptor_data *fdata;</span><br><span class="line">    zval *file_resource;</span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"r"</span>,&amp;file_resource) == FAILURE )</span><br><span class="line">    {</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    }</span><br><span class="line">    ZEND_FETCH_RESOURCE(fdata, php_sample_descriptor_data*,&amp;file_resource, <span class="number">-1</span>,PHP_SAMPLE_DESCRIPTOR_RES_NAME, le_sample_descriptor);</span><br><span class="line">    RETURN_STRING(fdata-&gt;filename, <span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>现在，Persistent Resources来了！</p><h3 id="Delayed-Destruction"><a href="#Delayed-Destruction" class="headerlink" title="Delayed Destruction"></a>Delayed Destruction</h3><p>在前面我们删除一个{资源}的时候，其实是去EG(regular_list)中将其删掉，EG(regular_list)存储着所有的只用在当前请求的{资源}。</p><p>持久{资源},存储在另一个HashTable中：EG(persistent_list)。其与EG(regular_list)有个明显的区别，那就是它每个值的索引都是字符串类型的，而且它的每个值也不会在每次请求结束后被释放掉，只能我们手动通过zend_hash_del()来删除，或者在进程结束后类似于MSHUTDOWN阶段将EG(persistent_list)整体清除，最常见的情景便是操作系统关闭了Web Server。<br>EG(persistent_list)对其元素也有自己的dtor回调函数，和EG(regular_list)一样，它将根据其值的类型去调用不同的回调函数，我们这一次注册回调函数的时候，需要用到zend_register_list_destructors_ex()函数的第二个参数，第一个则被赋成NULL。<br>在底层的实现中，持久的和regular{资源}是分别在不同的地方存储的，也分别拥有各自不同的释放函数。但在我们为脚本提供的函数中，却希望能够封装这种差异，从而使我们的用户使用起来更加方便快捷。<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> le_sample_descriptor_persist;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_sample_descriptor_dtor_persistent</span><span class="params">(zend_rsrc_list_entry *rsrc TSRMLS_DC)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    php_sample_descriptor_data *fdata = (php_sample_descriptor_data*)rsrc-&gt;ptr;</span><br><span class="line">    fclose(fdata-&gt;fp);</span><br><span class="line">    pefree(fdata-&gt;filename, <span class="number">1</span>);</span><br><span class="line">    pefree(fdata, <span class="number">1</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PHP_MINIT_FUNCTION(sample)</span><br><span class="line">{</span><br><span class="line">    le_sample_descriptor = zend_register_list_destructors_ex(php_sample_descriptor_dtor, <span class="literal">NULL</span>,PHP_SAMPLE_DESCRIPTOR_RES_NAME, module_number);</span><br><span class="line">    le_sample_descriptor_persist =zend_register_list_destructors_ex(<span class="literal">NULL</span>, php_sample_descriptor_dtor_persistent,PHP_SAMPLE_DESCRIPTOR_RES_NAME, module_number);</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>我们并没有为这两种{资源}起不同的名字，以防使用户产生疑惑。<br>现在我们的PHP扩展中引进了一种新的{资源}，所以我们需要改写一下上面的函数，<b>尽量使</b>用户使用时感觉不到这种差异。<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sample_fopen()</span></span><br><span class="line">PHP_FUNCTION(sample_fopen)</span><br><span class="line">{</span><br><span class="line">    php_sample_descriptor_data *fdata;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">char</span> *filename, *mode;</span><br><span class="line">    <span class="keyword">int</span> filename_len, mode_len;</span><br><span class="line">    zend_bool persist = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//类比一下mysql_connect函数的最后一个参数。</span></span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC,<span class="string">"ss|b"</span>,&amp;filename, &amp;filename_len, &amp;mode, &amp;mode_len,&amp;persist) == FAILURE)</span><br><span class="line">    {</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!filename_len || !mode_len)</span><br><span class="line">    {</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Invalid filename or mode length"</span>);</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    fp = fopen(filename, mode);</span><br><span class="line">    <span class="keyword">if</span> (!fp)</span><br><span class="line">    {</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Unable to open %s using mode %s"</span>,filename, mode);</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!persist)</span><br><span class="line">    {</span><br><span class="line">        fdata = emalloc(<span class="keyword">sizeof</span>(php_sample_descriptor_data));</span><br><span class="line">        fdata-&gt;filename = estrndup(filename, filename_len);</span><br><span class="line">        fdata-&gt;fp = fp;</span><br><span class="line">        ZEND_REGISTER_RESOURCE(return_value, fdata,le_sample_descriptor);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        list_entry le;</span><br><span class="line">        <span class="keyword">char</span> *hash_key;</span><br><span class="line">        <span class="keyword">int</span> hash_key_len;</span><br><span class="line"></span><br><span class="line">        fdata =pemalloc(<span class="keyword">sizeof</span>(php_sample_descriptor_data),<span class="number">1</span>);</span><br><span class="line">        fdata-&gt;filename = pemalloc(filename_len + <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(fdata-&gt;filename, filename, filename_len + <span class="number">1</span>);</span><br><span class="line">        fdata-&gt;fp = fp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在EG(regular_list中存一份)</span></span><br><span class="line">        ZEND_REGISTER_RESOURCE(return_value, fdata,le_sample_descriptor_persist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在EG(persistent_list)中再存一份</span></span><br><span class="line">        le.type = le_sample_descriptor_persist;</span><br><span class="line">        le.ptr = fdata;</span><br><span class="line">        hash_key_len = spprintf(&amp;hash_key, <span class="number">0</span>,<span class="string">"sample_descriptor:%s:%s"</span>, filename, mode);</span><br><span class="line">        zend_hash_update(&amp;EG(persistent_list),hash_key, hash_key_len + <span class="number">1</span>,(<span class="keyword">void</span>*)&amp;le, <span class="keyword">sizeof</span>(list_entry), <span class="literal">NULL</span>);</span><br><span class="line">        efree(hash_key);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>在持久{资源}时，因为我们在EG(regular_list)中也保存了一份，所以脚本中我们资源类型的变量在实现中仍然是保存着一个resource ID，我们可以用它来进行之前章节所做的工作。<br>将其添加到EG(persistent_list)中时，我们进行的操作流程几乎和ZEND_REGISTER_RESOURCE()宏函数一样，唯一的不同便是索引由之前的数字类型换成了字符串类型。<br>当一个保存在EG(regular_list)中的持久{资源}被脚本释放时，内核会在EG(regular_list)寻找它对应的dtor函数，但它找到的是NULL，因为我们在使用zend_register_list_destructors_ex()函数声明这种资源类型时，第一个参数的值为NULL。所以此时这个{资源}不会被任何dtor函数调用，可以继续存在于内存中，任脚本流逝，请求更迭。<br>当web server的进程执行完毕后，内核会扫描EG(persistent_list)的dtor，并调用我们已经定义好的释放函数。在我们定义的释放函数中，一定要记得使用pfree函数来释放内存，而不是efree。</p><h3 id="Reuse"><a href="#Reuse" class="headerlink" title="Reuse"></a>Reuse</h3><p>创建持久{资源}的目的是为了使用它，而不是让它来浪费内存的，我们再次重写一下sample_open()函数，这一次我们将检测需要创建的资源是否已经在persistent_list中存在了。<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(sample_fopen)</span><br><span class="line">{</span><br><span class="line">    php_sample_descriptor_data *fdata;</span><br><span class="line">    FILE *fp;</span><br><span class="line">    <span class="keyword">char</span> *filename, *mode, *hash_key;</span><br><span class="line">    <span class="keyword">int</span> filename_len, mode_len, hash_key_len;</span><br><span class="line">    zend_bool persist = <span class="number">0</span>;</span><br><span class="line">    list_entry *existing_file;</span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC,<span class="string">"ss|b"</span>,&amp;filename, &amp;filename_len, &amp;mode, &amp;mode_len,&amp;persist) == FAILURE)</span><br><span class="line">    {</span><br><span class="line">        RETURN_NULL();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!filename_len || !mode_len)</span><br><span class="line">    {</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Invalid filename or mode length"</span>);</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//看看是否已经存在，如果已经存在就直接使用，不再创建</span></span><br><span class="line">    hash_key_len = spprintf(&amp;hash_key, <span class="number">0</span>,<span class="string">"sample_descriptor:%s:%s"</span>, filename, mode);</span><br><span class="line">    <span class="keyword">if</span> (zend_hash_find(&amp;EG(persistent_list), hash_key,hash_key_len + <span class="number">1</span>, (<span class="keyword">void</span> **)&amp;existing_file) == SUCCESS)</span><br><span class="line">    {</span><br><span class="line">    	<span class="comment">//存在一个，直接使用！</span></span><br><span class="line">        ZEND_REGISTER_RESOURCE(return_value,existing_file-&gt;ptr, le_sample_descriptor_persist);</span><br><span class="line">        efree(hash_key);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    fp = fopen(filename, mode);</span><br><span class="line">    <span class="keyword">if</span> (!fp)</span><br><span class="line">    {</span><br><span class="line">        php_error_docref(<span class="literal">NULL</span> TSRMLS_CC, E_WARNING,<span class="string">"Unable to open %s using mode %s"</span>,filename, mode);</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!persist)</span><br><span class="line">    {</span><br><span class="line">        fdata = emalloc(<span class="keyword">sizeof</span>(php_sample_descriptor_data));</span><br><span class="line">        fdata-&gt;filename = estrndup(filename, filename_len);</span><br><span class="line">        fdata-&gt;fp = fp;</span><br><span class="line">        ZEND_REGISTER_RESOURCE(return_value, fdata,le_sample_descriptor);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        list_entry le;</span><br><span class="line">        fdata =pemalloc(<span class="keyword">sizeof</span>(php_sample_descriptor_data),<span class="number">1</span>);</span><br><span class="line">        fdata-&gt;filename = pemalloc(filename_len + <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(fdata-&gt;filename, filename, filename_len + <span class="number">1</span>);</span><br><span class="line">        fdata-&gt;fp = fp;</span><br><span class="line">        ZEND_REGISTER_RESOURCE(return_value, fdata,le_sample_descriptor_persist);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Store a copy in the persistent_list */</span></span><br><span class="line">        le.type = le_sample_descriptor_persist;</span><br><span class="line">        le.ptr = fdata;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//hash_key在上面已经被创建了</span></span><br><span class="line">        zend_hash_update(&amp;EG(persistent_list),hash_key, hash_key_len + <span class="number">1</span>,(<span class="keyword">void</span>*)&amp;le, <span class="keyword">sizeof</span>(list_entry), <span class="literal">NULL</span>);</span><br><span class="line">    }</span><br><span class="line">    efree(hash_key);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p></p><p>因为所有的PHP扩展都共用同一个HashTable来保存持久{资源}，所以我们在为{资源}的索引起名时，一定要唯一，同时必须简单，方便我们在其它的函数中构造出来。</p><h3 id="Liveness-Checking-and-Early-Departure"><a href="#Liveness-Checking-and-Early-Departure" class="headerlink" title="Liveness Checking and Early Departure"></a>Liveness Checking and Early Departure</h3><p>一旦我们打开一个本地文件，便可以一直占有它的操作句柄，保证随时可以打开它。但是对于一些存在于远程计算机上的资源，比如mysql链接、http链接，虽然我们仍然握着与服务器的链接，但是这个链接在服务器端可能已经被关闭了，在本地我们就无法再用它来做一些有价值的工作了。</p><p>所以，当我们使用{资源}，尤其是持久{资源}时，一定要保证获取出来的{资源}仍然是有效的、可以使用的。如果它失效了，我们必须将其从persistent list中移除。下面就是一个检测socket有效性的例子：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (zend_hash_find(&amp;EG(persistent_list), hash_key,hash_key_len + <span class="number">1</span>, (<span class="keyword">void</span>**)&amp;socket) == SUCCESS)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (php_sample_socket_is_alive(socket-&gt;ptr))</span><br><span class="line">    {</span><br><span class="line">        ZEND_REGISTER_RESOURCE(return_value,socket-&gt;ptr, le_sample_socket);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    zend_hash_del(&amp;EG(persistent_list),hash_key, hash_key_len + <span class="number">1</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>如你所见，{资源}失效后，我们只要把它从HashTable中删除就行了，这一步操作同样会激活我们设置的回调函数。On completion of this code block, the function will be in the same state it would have been if no resource had been found in the persistent list.</p><h3 id="Agnostic-Retrieval"><a href="#Agnostic-Retrieval" class="headerlink" title="Agnostic Retrieval"></a>Agnostic Retrieval</h3><p>现在我们已经可以创建资源类型并生成新的资源，还能将持久{资源}与平常{资源}使用的差异性封装起来。但是如果用户对一个持久{资源}调用sample_fwrite()时候并不会正常工作，先想一下内核是如何通过一个数字所以在regular_list中获取最终资源的。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ZEND_FETCH_RESOURCE(</span><br><span class="line">	fdata,</span><br><span class="line">	php_sample_descriptor_data*,</span><br><span class="line">    &amp;file_resource,</span><br><span class="line">    <span class="number">-1</span>,</span><br><span class="line">    PHP_SAMPLE_DESCRIPTOR_RES_NAME,</span><br><span class="line">    le_sample_descriptor</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p>le_sample_descriptor可以保证你获取到的资源确实是这种类型的，绝不会出现你想要一个文件句柄，却返回给你一个mysql链接的情况。这种验证是必须的，但有时你又想绕过这种验证，因为我们放在persistenst_list中的{资源}是le_sample_descruotor_persist类型的，所以当我们把它复制到regular_list中时，它也是le_sample_descructor_persist的，所以如果我们想获取它，貌似只有两种方法，要么修改类型，要么再写一个新的sample_write_persistent函数的实现。或者极端一些，在sample_write函数里进行复杂的判断。但是如果sample_write()函数能同时接收它们两种类型的{资源}多好啊….</p><p>事情没有这么复杂，我们确实可以在sample_write()函数里获取{资源}时候同时指定两种类型。那就是使用ZEND_FETCH_RESOURCE2()宏函数，它与ZEND_FETCH_RESOURCE()宏函数的唯一区别就是它可以接收两种类型参数。<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ZEND_FETCH_RESOURCE2(</span><br><span class="line">	fdata,</span><br><span class="line">	php_sample_descriptor_data*,</span><br><span class="line">    &amp;file_resource,</span><br><span class="line">    <span class="number">-1</span>,</span><br><span class="line">    PHP_SAMPLE_DESCRIPTOR_RES_NAME,</span><br><span class="line">    le_sample_descriptor,</span><br><span class="line">    le_sample_descriptor_persist</span><br><span class="line">);</span><br></pre></td></tr></tbody></table></figure><p></p><p>现在，只要resource ID对应的最终资源类型是persistent或者non-persistent的一种便可以正常通过验证了。</p><p>什么，你想设置三种甚至更多的类型？!!那你只能直接使用zend_fetch_resource()函数了。<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一种类型的</span></span><br><span class="line">fp = (FILE*) zend_fetch_resource(</span><br><span class="line">		&amp;file_descriptor TSRMLS_CC,</span><br><span class="line">		<span class="number">-1</span>,</span><br><span class="line">		PHP_SAMPLE_DESCRIPTOR_RES_NAME,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">1</span>,</span><br><span class="line">		le_sample_descriptor</span><br><span class="line">);</span><br><span class="line">ZEND_VERIFY_RESOURCE(fp);</span><br></pre></td></tr></tbody></table></figure><p></p><p>想看看ZEND_FETCH_RESOURCE2()宏函数的实现么？<br></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//两种类型的</span></span><br><span class="line">fp = (FILE*) zend_fetch_resource(</span><br><span class="line">		&amp;file_descriptor TSRMLS_CC,</span><br><span class="line">		<span class="number">-1</span>,</span><br><span class="line">		PHP_SAMPLE_DESCRIPTOR_RES_NAME,</span><br><span class="line">		<span class="literal">NULL</span>,</span><br><span class="line">		<span class="number">2</span>,</span><br><span class="line">		le_sample_descriptor,</span><br><span class="line">		le_sample_descriptor_persist</span><br><span class="line">);</span><br><span class="line">ZEND_VERIFY_RESOURCE(fp);</span><br></pre></td></tr></tbody></table></figure><p></p><p>再给力一些，三种类型的：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fp = (FILE*) zend_fetch_resource(</span><br><span class="line">	&amp;file_descriptor TSRMLS_CC,</span><br><span class="line">	<span class="number">-1</span>,</span><br><span class="line">    PHP_SAMPLE_DESCRIPTOR_RES_NAME,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">    <span class="number">3</span>,</span><br><span class="line">    le_sample_descriptor,</span><br><span class="line">    le_sample_descriptor_persist,</span><br><span class="line">    le_sample_othertype</span><br><span class="line">);</span><br><span class="line">ZEND_VERIFY_RESOURCE(fp);</span><br></pre></td></tr></tbody></table></figure><p>话都说到这份上了，你肯定知道四种、五种、更多种类型的应该怎么调用了。</p><h1 id="9-3-PHP中的资源类型"><a href="#9-3-PHP中的资源类型" class="headerlink" title="9.3 PHP中的资源类型"></a>9.3 PHP中的资源类型</h1><p>zval通过引用计数来节省内存的，这个我们都知道了，但你可能不知道的是，某个zval对应的{资源}在实现时也使用了引用计数这种概念，也就是有了两种引用计数！</p><p>{资源}对应的zval的类型是IS_RESOURCE，它并不保存最终的数据，而只保存一个数字，即EG(regular_list)中的数字索引。</p><p>当{资源}被创建时，比如我们调用sample_fopen()函数：<br></p><figure class="highlight php"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$a = sample_fopen(<span class="string">'notes.txt'</span>, <span class="string">'r'</span>);</span><br><span class="line"><span class="comment">//此时：var-&gt;refcount__gc = 1, rsrc-&gt;refcount = 1</span></span><br><span class="line"></span><br><span class="line">$b = $a;</span><br><span class="line"><span class="comment">//此时：var-&gt;refcount__gc = 2, rsrc-&gt;refcount = 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($b);</span><br><span class="line"><span class="comment">//此时：var-&gt;refcount__gc = 1, rsrc-&gt;refcount = 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> 下面来个复杂的！</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">$b = $a;</span><br><span class="line">$c = &amp;$a;</span><br><span class="line"><span class="comment">//此时：</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	bvar-&gt;refcount = 1, bvar-&gt;is_ref = 0</span></span><br><span class="line"><span class="comment">	acvar-&gt;refcount = 2, acvar-&gt;is_ref = 1</span></span><br><span class="line"><span class="comment">	rsrc-&gt;refcount = 2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure><p></p><p>现在，如果我们unset($b)，内核只会把rsrc-&gt;refcount的值减1。只有当rsrc-&gt;refcount的值为0时，我们预设的dtor释放函数才会被激活并调用。</p><h1 id="9-4-PHP中的资源类型"><a href="#9-4-PHP中的资源类型" class="headerlink" title="9.4 PHP中的资源类型"></a>9.4 PHP中的资源类型</h1><p>通过这一章介绍的技术，我们已经可以使用PHP中{资源}了，这将使我们更容易的在扩展中使用一些第三方库，比如使用zip扩展时，我们需要把它的一些特殊的量封装成资源供脚本使用。这无疑极大的增强了PHP的威力！{资源}V5!</p><p><br>下一章将会说一下PHP中的对象！原书中分别讲述了PHP4与PHP5的实现，这里我没有参照原书的安排，按照自己的理解完全重写了这一部分，以PHP5为基础讲述，确切的说，是以PHP5.3.6讲述，这个版本问题我也已经在本书开头说明了，因为我私自认为PHP4已经不再重要了。</p></div><footer class="post-footer"><div class="post-tags"><a href="/tags/php-ext/" rel="tag"># php_ext</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/e0f3b7fd.html" rel="next" title="8 使用HashTable与{数组}"><i class="fa fa-chevron-left"></i> 8 使用HashTable与{数组}</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/9da79ce3.html" rel="prev" title="10 PHP中的面向对象（一）">10 PHP中的面向对象（一） <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">phantom9999</p><p class="site-description motion-element" itemprop="description">cpp,php相关的个人博客</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">131</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">6</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">24</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/phantom9999" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#9-PHP中的资源类型"><span class="nav-number">1.</span> <span class="nav-text">9 PHP中的资源类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-1-PHP中的资源类型"><span class="nav-number">2.</span> <span class="nav-text">9.1 PHP中的资源类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Forcing-Destruction"><span class="nav-number">2.0.1.</span> <span class="nav-text">Forcing Destruction</span></a></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#9-2-PHP中的资源类型"><span class="nav-number">3.</span> <span class="nav-text">9.2 PHP中的资源类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Delayed-Destruction"><span class="nav-number">3.0.1.</span> <span class="nav-text">Delayed Destruction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reuse"><span class="nav-number">3.0.2.</span> <span class="nav-text">Reuse</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Liveness-Checking-and-Early-Departure"><span class="nav-number">3.0.3.</span> <span class="nav-text">Liveness Checking and Early Departure</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Agnostic-Retrieval"><span class="nav-number">3.0.4.</span> <span class="nav-text">Agnostic Retrieval</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-3-PHP中的资源类型"><span class="nav-number">4.</span> <span class="nav-text">9.3 PHP中的资源类型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#9-4-PHP中的资源类型"><span class="nav-number">5.</span> <span class="nav-text">9.4 PHP中的资源类型</span></a></li></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">© <span itemprop="copyrightYear">2020</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">phantom9999</span></div><div class="powered-by">由 <a class="theme-link" target="_blank" rel="external nofollow" href="https://hexo.io">Hexo</a> 强力驱动 v3.9.0</div><span class="post-meta-divider">|</span><div class="theme-info">主题 — <a class="theme-link" target="_blank" rel="external nofollow" href="https://github.com/theme-next/hexo-theme-next">NexT.Gemini</a> v6.3.0</div></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/velocity/1.2.1/velocity.ui.min.js"></script><script type="text/javascript" src="https://cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/live2d-widget@^3.1.3/lib/L2Dwidget.min.js"></script><script type="text/javascript" src="/bundle.js"></script><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });;
L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":true,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-haruto@1.0.5/assets/haruto.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true}});</script></body></html>